# Этапы 4 и 5 — что сделано и как проверить

## Этап 4 — Поведение AI

### Сделано

1. **Не приветствовать первым**  
   В настройках тенанта поле `respondFirst` по умолчанию `false`: AI не пишет первым, только отвечает на сообщения клиента (логика уже была: ответ только после входящего).

2. **Если тема не ясна — один раз вежливо спросить**  
   В системном промпте добавлено: «Если тема не ясна в первых сообщениях — один раз вежливо спроси: "Подскажите, пожалуйста, что вас интересует: панели, ламинат, линолеум или другая продукция?" Не повторяй этот вопрос многократно.»

3. **Системный промпт (в коде и по умолчанию):**
   - Работа на казахском без «тупых» ответов: «Если пишут на казахском — отвечай на казахском полноценно, без шаблонных фраз».
   - Обязательная обработка голосовых: «Если клиент прислал голосовое — учитывай суть и отвечай по существу».
   - Определение темы и один раз спросить, если не ясно (см. выше).
   - Явно: «Не приветствуй первым — только отвечай на реплики клиента.»

4. **Сценарии и медиа по темам**  
   В таблице тем (TenantTopic) добавлены поля:
   - `scenarioText` (текст) — сценарий/инструкция для AI по теме (панели, ламинат и т.д.).
   - `mediaUrl` — ссылка на медиа по теме (когда готово).  
   Если у лида задана тема и у темы заполнен сценарий, он подставляется в системный промпт при генерации ответа: «Сценарий по текущей теме (Панели) — придерживайся его в ответах: …».

### Как проверить (Этап 4)

- Написать клиенту с казахского номера — ответ должен быть на казахском, без шаблонных отписок.
- Отправить голосовое (или текст с пометкой [Голосовое сообщение]) — ответ должен учитывать суть.
- Написать что-то неочевидное по теме — один раз должен прийти вежливый вопрос, чем интересуется клиент.
- В настройках CRM → Темы: у темы (например, «Панели») заполнить «Сценарий для AI», сохранить. Создать/привязать лида к этой теме — в ответах AI должен использовать сценарий.
- Готовый блок промпта для вставки в систему: см. `docs/SYSTEM-PROMPT-DEFAULT.txt`.

---

## Этап 5 — CRM для владельца и менеджеров

### Сделано

1. **Редактор воронки у владельца**  
   На странице «Настройки» в блоке «Этапы воронки» у каждого этапа есть кнопка **«Изменить»**: можно менять название этапа, тип (new, in_progress, wants_call, full_data, success, refused) и привязку к теме (выпадающий список тем или «Без темы»). Сохранение через API `PATCH /pipeline/:id`.

2. **Фильтрация по темам и видимость**  
   - В списке/канбане заявок добавлен фильтр **«Тема»** (выпадающий список: «Все темы» + все темы тенанта). При выборе темы запрос к API идёт с `topicId`; бэкенд по-прежнему применяет видимость по темам для менеджеров (visibleTopicIds), так что менеджер видит только свои темы, владелец/РОП — все, но могут сузить список по выбранной теме.
   - API: `GET /leads?topicId=...` добавлен и учтён в `LeadsService.list()`.

3. **Видимость по темам при создании/редактировании пользователя**  
   Уже реализовано: при создании пользователя (роль «Менеджер») отображаются чекбоксы по списку тем из `topics.list()`; при сохранении в API передаётся `visibleTopicIds`. Для существующего пользователя есть «Изменить» в колонке «Темы» и вызов `users.updateVisibleTopics(userId, visibleTopicIds)`. Жёсткого лимита «2 менеджера» нет — темы задаются гибко.

### Как проверить (Этап 5)

- Войти как владелец/РОП → Настройки → Этапы воронки: нажать «Изменить» у этапа, поменять название, тип, тему → Сохранить. Убедиться, что изменения отображаются в канбане и в карточке лида.
- Настройки → Темы лидов: нажать «Изменить» у темы, заполнить сценарий и/или ссылку на медиа → Сохранить.
- Заявки: выбрать в фильтре «Тема» конкретную тему — список должен содержать только лиды с этой темой (с учётом видимости: менеджер видит только свои темы).
- Пользователи: создать менеджера, отметить несколько тем в «Видит темы»; у другого менеджера нажать «Изменить» и изменить набор тем — проверить, что в заявках у каждого только свои лиды по темам.

---

## Миграция БД (Этап 4)

В каталоге `apps/api` выполнить:

```bash
npx prisma migrate dev --name add_topic_scenario_media_respond_first
```

Будут добавлены: у таблицы тем поля `scenarioText` и `mediaUrl`; у настроек тенанта значение по умолчанию `respondFirst = false` (если миграция это предусматривает; иначе можно задать вручную в админке/БД).
