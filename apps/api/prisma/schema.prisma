generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  status    String   @default("active") // active, pause, error
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  pipelineStages     PipelineStage[]
  leads              Lead[]
  settings           TenantSettings?
  followUpTemplates  FollowUpTemplate[]
  systemLogs         SystemLog[]
  channels           TenantChannel[]
  topics             TenantTopic[]
}

// Универсально: у тенанта несколько каналов (WhatsApp-номера). Лид привязан к каналу.
// externalId = идентификатор из ChatFlow (instance_id и т.п.) — один webhook, в теле передаётся instance_id.
model TenantChannel {
  id         String   @id @default(cuid())
  tenantId   String
  name       String   // "Номер 1", "Панели" — для отображения в CRM
  externalId String   // instance_id или иной ID из webhook ChatFlow; для "дефолтного" канала можно "default"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leads  Lead[]

  @@unique([tenantId, externalId])
  @@index([tenantId])
}

// Универсально: темы/категории лидов настраиваются владельцем (панели, ламинат, линолеум или что угодно).
model TenantTopic {
  id           String   @id @default(cuid())
  tenantId     String
  name         String
  sortOrder    Int      @default(0)
  scenarioText String?  @db.Text   // Этап 4: сценарий/инструкция для AI по теме (панели, ламинат и т.д.)
  mediaUrl     String?  // ссылка на медиа по теме (когда готово)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leads   Lead[]
  stages  PipelineStage[]
  visibleToUsers UserVisibleTopic[]

  @@index([tenantId])
}

// Какой пользователь какие темы видит (пустой список = видит все; для owner/rop можно не заполнять).
model UserVisibleTopic {
  userId  String
  topicId String

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic TenantTopic  @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([userId, topicId])
  @@index([topicId])
}

model GlobalAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model TenantSettings {
  id                String   @id @default(cuid())
  tenantId          String   @unique
  aiEnabled         Boolean  @default(true)
  openaiApiKey      String?  // Ключ OpenAI для GPT-ответов (по клиенту)
  openaiModel       String?  // Модель: gpt-4o-mini (по умолчанию), gpt-4o и др.
  chatflowInstanceId String?
  chatflowApiToken  String?
  webhookUrl        String?
  webhookKey        String?  @unique // ключ для входа по ?key= (как у тебя было: tenant.webhook_key)
  systemPrompt     String?   @db.Text
  respondFirst     Boolean  @default(false)  // false = не приветствовать первым, ждать сообщение клиента
  suggestCall      Boolean  @default(true)
  askQuestions     Boolean  @default(true)
  nightModeEnabled Boolean  @default(false)
  nightModeStart   String?  // "22:00"
  nightModeEnd     String?  // "08:00"
  nightModeMessage String?  @db.Text
  followUpEnabled  Boolean  @default(true)
  followUpDelay    String?  // "15" (minutes) or "1" (hour)
  followUpMessage  String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model FollowUpTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  messageText String   @db.Text
  delayLabel  String   // "+5 мин", "+24 часа", "+7 дней"
  delayMinutes Int     // for sorting/scheduling
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

enum UserRole {
  owner
  rop
  manager
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  passwordHash String
  name      String?
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedLeads  Lead[]             @relation("AssignedLeads")
  visibleTopics  UserVisibleTopic[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model PipelineStage {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  order     Int
  type      String   // new, in_progress, wants_call, full_data, success, refused
  topicId   String?  // если null — этап общий (например Успех/Отказ)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  topic  TenantTopic? @relation(fields: [topicId], references: [id], onDelete: SetNull)
  leads  Lead[]

  @@index([tenantId])
  @@index([topicId])
}

enum LeadScore {
  hot
  warm
  cold
}

model Lead {
  id             String    @id @default(cuid())
  tenantId       String
  channelId      String?   // с какого номера WhatsApp написали; null = старые лиды (миграция подставит default)
  stageId        String
  topicId        String?   // тема/категория (определяется по диалогу)
  assignedUserId String?
  leadScore      LeadScore @default(cold)
  aiActive       Boolean   @default(true)
  phone          String
  name           String?
  metadata       Json?     // city, dimensions, etc.
  lastMessageAt  DateTime?
  lastMessagePreview String?
  noResponseSince DateTime?
  aiNotes        String?   @db.Text
  aiReplyScheduledAt DateTime?  // Этап 3: ответить через 1 мин после последнего входящего
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channel  TenantChannel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  stage    PipelineStage  @relation(fields: [stageId], references: [id], onDelete: Restrict)
  topic    TenantTopic?   @relation(fields: [topicId], references: [id], onDelete: SetNull)
  assignedUser User?      @relation("AssignedLeads", fields: [assignedUserId], references: [id], onDelete: SetNull)
  messages Message[]

  @@index([tenantId])
  @@index([channelId])
  @@index([stageId])
  @@index([topicId])
  @@index([assignedUserId])
  @@index([tenantId, lastMessageAt])
  @@index([tenantId, phone, channelId])
  @@index([aiReplyScheduledAt])
}

enum MessageSource {
  ai
  human
}

enum MessageDirection {
  in
  out
}

model Message {
  id        String   @id @default(cuid())
  leadId    String
  source    MessageSource
  direction MessageDirection
  body      String?
  mediaUrl  String?
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

enum SystemLogCategory {
  whatsapp
  ai
  system
}

model SystemLog {
  id        String            @id @default(cuid())
  tenantId  String?
  category  SystemLogCategory
  message   String            @db.Text
  meta      Json?
  createdAt DateTime          @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([category, createdAt])
}

model SystemSettings {
  id              String   @id @default("singleton")
  defaultTimezone String   @default("Europe/Moscow")
  maintenanceMode Boolean  @default(false)
  aiGlobalEnabled Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
