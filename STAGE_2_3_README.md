# Этапы 2 и 3 — что сделано и как проверить

## Этап 2 — Отображение и ответы с нужного номера

### Сделано
- **Карточка лида (CRM):** в сайдбаре карточки лида отображается блок «Пишет на номер: {название канала}». В списке заявок (канбан) на каждой карточке при наличии канала выводится строка «Канал: {название}».
- **Ответы с того же номера:** исходящие сообщения (и от AI, и из CRM) отправляются только с того номера/канала, на который пишет клиент: используется `lead.channelId` → `externalId` (instance_id) для ChatFlow API. Логика уже была в webhook и в `MessagesService.createForLead`; добавлен общий метод `MessagesService.sendToLead(tenantId, leadId, body)` для отправки в WhatsApp (используется при отложенном ответе из крона).

### Как проверить
1. В настройках создать каналы с разными `externalId` (номера/instance_id).
2. Принять входящее с webhook с разными `instance_id` / `channelId` — у лидов должны быть разные каналы.
3. В карточке лида и в канбане должен отображаться канал.
4. Отправить ответ из CRM или дождаться ответа AI — сообщение должно уходить с того же номера (того же instance_id), что и диалог с клиентом.

---

## Этап 3 — Задержка и один ответ

### Сделано
- **Задержка 1 мин:** после каждого входящего сообщения ответ не отправляется сразу. Вместо этого выставляется `lead.aiReplyScheduledAt = now + 1 мин`. Входящее сохраняется в БД через `MessagesService.createForLead`.
- **Один ответ на пачку:** раз в 30 секунд крон вызывает `AiService.processScheduledReplies()`. Он находит лидов с `aiReplyScheduledAt <= now` и для каждого:
  - берёт все входящие сообщения после последнего исходящего (пачка);
  - склеивает их в один текст;
  - один раз вызывает `handleFakeIncoming(..., skipSaveIncoming: true)` (оценка, этап, генерация ответа по полному контексту);
  - сохраняет один ответ в БД и отправляет его в WhatsApp через `MessagesService.sendToLead`.
- В Prisma у модели `Lead` добавлено поле `aiReplyScheduledAt` (DateTime?, индекс для выборки по расписанию).

### Как проверить
1. Включить AI у тенанта и у лида.
2. Отправить с webhook несколько входящих подряд (например, 3 сообщения в течение 1–2 минут).
3. Убедиться, что сразу ответ не приходит.
4. Через ≥1 минуту после последнего входящего должен прийти один ответ от AI по контексту всех сообщений пачки.
5. В логах/БД: у лида выставляется `aiReplyScheduledAt`, затем крон обрабатывает и очищает поле; в чате — одна запись исходящего от AI.

### Миграция БД
Выполнить в каталоге `apps/api`:
```bash
npx prisma migrate dev --name add_ai_reply_scheduled_at
```
(или применить сгенерированную миграцию на продовой БД).
