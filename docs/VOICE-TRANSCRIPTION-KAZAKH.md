# Распознавание голосовых сообщений на казахском

## Как это работает

1. Клиент отправляет голосовое в WhatsApp → ChatFlow пересылает его в наш вебхук с `mediaData.url` (ссылка на аудио).
2. API скачивает аудио и отправляет его в **OpenAI Whisper** для распознавания речи.
3. Текст подставляется в сообщение лида вместо плейсхолдера «Голосовое сообщение» и используется для ответа AI.

## Что настроено в коде

- **Язык:** если в последних сообщениях лида есть казахские буквы (ә, ғ, қ, ң, ү, ұ, һ, ө, і), для распознавания голоса передаётся `language: 'kk'` (казахский). Так Whisper даёт более точный результат.
- **Словарь (prompt):** в Whisper передаётся подсказка с лексикой: панели, трактор, ламинат, тенге, Алматы, сатып алу, баға сұрау, жүк көлем, мәліметтер и т.д. Это улучшает распознавание терминов и типичных фраз.

## Что проверить у себя

1. **OpenAI API ключ**  
   В настройках клиента (тенанта) в BuildCRM должен быть указан **OpenAI API Key**. Без него транскрипция не выполняется, в чат попадёт только «Голосовое сообщение».

2. **Доступ ChatFlow к аудио**  
   В теле вебхука от ChatFlow должно приходить поле `mediaData.url` — публичная ссылка на файл голосового. Если ChatFlow не передаёт `mediaData` или URL недоступен с нашего сервера, распознавание не сработает.

3. **Первый голосовой без истории**  
   Если лид пишет **первым сообщением** голосовым (ещё нет текстовых сообщений), язык определяется автоматически. Точность может быть ниже, чем когда в переписке уже был казахский текст и мы явно передаём `language: 'kk'`.

## Если распознавание всё ещё плохое

- Убедиться, что в переписке перед голосовым было хотя бы одно **текстовое** сообщение на казахском — тогда следующие голосовые будут распознаваться с `language: 'kk'`.
- Проверить качество аудио: шумы и сильный акцент ухудшают результат.
- Whisper лучше всего работает с чёткой речью; очень короткие или невнятные сообщения могут распознаваться с ошибками.
