# Сообщение в WhatsApp «начинает писаться и обрывается» — что проверить

## 1. Логи в BuildCRM (админка)

1. Зайди в **админку** → **Логи** (или карточка клиента → вкладка **Логи**).
2. Отфильтруй по клиенту и по категории **whatsapp** или **ai**.
3. Проверь:
   - Есть ли запись **«ChatFlow webhook received»** в момент, когда ты написал в WhatsApp?  
     → Если **есть**: запрос от ChatFlow доходит до нашего API.  
     → Если **нет**: до нашего API запрос не доходит (проблема в ChatFlow или URL вебхука).
   - Есть ли записи **«AI ответил на сообщение»** или **«OpenAI ошибка»**?  
     → Если есть «OpenAI ошибка» — в логе будет текст ошибки (например, неверный ключ или лимит).

## 2. Логи API на Render

1. [dashboard.render.com](https://dashboard.render.com) → сервис **buildcrm-api** → вкладка **Logs**.
2. В момент отправки сообщения в WhatsApp открой логи (или включи Live tail).
3. Смотри:
   - Появляется ли запрос `POST /webhooks/chatflow/...`?
   - Нет ли красных строк с ошибкой (exception, 500, timeout)?

На free tier API может «засыпать»: первый запрос после паузы идёт 30–60 сек и иногда обрывается по таймауту. Если ChatFlow ждёт ответ не больше 10–15 сек — он может оборвать запрос до того, как мы ответим.

## 3. ChatFlow

1. В личном кабинете ChatFlow открой **логи доставки** / **webhook logs** (если есть).
2. Проверь:
   - Уходит ли запрос на наш URL и какой приходит **статус** (200, 201, 5xx, timeout)?
   - Какой **ответ тела** приходит от нас? Мы отдаём `{ "received": true, "tenantId": "...", "reply": "текст ответа бота или null" }`. В ChatFlow нужно настроить отправку в WhatsApp поля **reply** из ответа вебхука.

## 4. Ответ вебхука (как настроить ChatFlow)

Наш вебхук теперь:
1. Принимает тело от ChatFlow (ожидаются поля с текстом сообщения и номером отправителя — см. ниже).
2. Находит или создаёт лида по номеру телефона.
3. Вызывает AI (как при «фейковом» входящем): сохраняет сообщение, генерирует ответ (OpenAI или шаблон).
4. Возвращает в ответе: `{ "received": true, "tenantId": "...", "reply": "текст для отправки в WhatsApp" }` или `reply: null`, если ответа нет.

**В ChatFlow** в сценарии после вызова вебхука нужно взять из ответа поле **reply** и отправить его как сообщение в WhatsApp. Если ChatFlow ожидает другое имя поля (например `message` или `text`), можно добавить алиас в наш API или в ChatFlow подставить `body.reply`.

Поддерживаемые форматы тела запроса от ChatFlow (хотя бы один должен совпадать):
- `message.text` и `message.from` или `from` в корне
- `text` и `phone` или `from` в корне
- `messages[0].text` / `messages[0].body` и `messages[0].from` или `messages[0].context.from`

Номер телефона нормализуется (только цифры); для создания лида нужна хотя бы одна стадия воронки у клиента.

## 5. Что ещё проверить

- **Если вебхук не вызывается** — проверить URL вебхука в ChatFlow (buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>).
- **Если вебхук вызывается, но reply всегда null** — в **ответе вебхука** (в логе ChatFlow «Response Body») теперь есть поле **`debug`**:
  - `debug.reason === "parse_failed"` и `debug.bodyKeys` — мы не смогли найти текст/номер в теле; посмотри `bodyKeys` и добавь в запрос ChatFlow поля с текстом сообщения и номером отправителя (или пришли нам `bodyKeys` — добавим поддержку).
  - `debug.reason === "no_pipeline_stages"` — у клиента нет ни одной стадии воронки в CRM.
  - `debug.reason === "ai_error"` и `debug.error` — ошибка при вызове AI (например, неверный ключ OpenAI).
  В логах админки: «ChatFlow webhook received» (полное тело), «ChatFlow: не удалось извлечь text/phone», «ChatFlow: ошибка AI».
- **Если видишь «OpenAI ошибка» в логах** — проверить ключ в AI-настройках клиента и лимиты на platform.openai.com.

После проверки логов можно прислать сюда: есть ли «ChatFlow webhook received», есть ли «OpenAI ошибка» и как в ChatFlow настроен шаг «отправить в webhook» и «отправить сообщение в WhatsApp» (откуда берётся текст). Тогда можно точечно предложить правки в коде или в сценарии.
