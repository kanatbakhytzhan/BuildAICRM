# Три номера WhatsApp → один webhook (универсальная CRM)

## Идея

У одного тенанта (компании) может быть **несколько номеров** WhatsApp (например три — из‑за потока клиентов). Все номера могут получать сообщения по **любым темам**; тема лида определяется по диалогу, а не по номеру.

В CRM каждый лид привязан к **каналу** (номеру). Ответы (и от AI, и от менеджера) уходят **с того же номера**, на который написал клиент.

## Один URL webhook на все номера

1. В ChatFlow настройте **один и тот же URL** для всех трёх инстансов (номеров), например:
   - `https://your-api.com/webhooks/chatflow?key=ВАШ_WEBHOOK_KEY`

2. В **теле каждого запроса** ChatFlow должен передавать идентификатор номера, с которого пришло сообщение. Поддерживаются поля:
   - `instance_id` (в корне тела или в `metadata.instance_id`)
   - или `channelId`

   Пример тела от ChatFlow:
   ```json
   {
     "message": "Текст сообщения",
     "metadata": {
       "remoteJid": "77001234567@s.whatsapp.net",
       "sender": "Имя",
       "instance_id": "abc123"
     }
   }
   ```
   Здесь `instance_id` — идентификатор инстанса/номера в ChatFlow. Мы сохраняем его как `externalId` канала и при ответе вызываем `send-text` с этим же `instance_id`, чтобы ответ ушёл с нужного номера.

3. Если в запросе **нет** `instance_id` / `channelId`, используется канал с `externalId = "default"` (один номер на тенанта — как раньше). Такой канал создаётся при seed для каждого тенанта.

## Настройка каналов в CRM

Владелец/РОП в CRM (или через API) создаёт **каналы** для каждого номера:

| Название (для отображения) | externalId (instance_id из ChatFlow) |
|----------------------------|--------------------------------------|
| Номер 1 — Панели          | `instance_xxx`                       |
| Номер 2                   | `instance_yyy`                       |
| Номер 3                   | `instance_zzz`                       |

В настройках тенанта по‑прежнему один **chatflowApiToken** (общий для аккаунта ChatFlow). При отправке мы подставляем в запрос `instance_id` из канала лида (или из настроек, если канал «Основной» / default).

## Альтернатива: три разных URL

Если ChatFlow не умеет слать `instance_id` в теле, можно завести **три webhook URL** с разными ключами или параметрами, например:

- `?key=KEY&instance_id=id1`
- `?key=KEY&instance_id=id2`
- `?key=KEY&instance_id=id3`

Тогда `instance_id` берётся из query. В CRM нужно заранее создать каналы с этими `externalId` (id1, id2, id3).
