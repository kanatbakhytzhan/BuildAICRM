# Как должен выглядеть поток в ChatFlow (конструктор) для BuildCRM

Ниже — схема и настройки, которые нужны, чтобы входящие сообщения WhatsApp обрабатывались BuildCRM (лид + AI) и ответ уходил обратно в чат.

---

## 1. Схема потока (общая)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Входящее сообщение в WhatsApp                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 1: Вызвать внешний вебхук (BuildCRM API)                                │
│  • URL: https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>       │
│  • Метод: POST                                                               │
│  • Тело: передать текст сообщения и номер отправителя (см. ниже)             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 2: Взять из ответа вебхука поле "reply"                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ШАГ 3: Отправить в WhatsApp сообщение с текстом = reply                      │
│  (тому же пользователю, который написал)                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

Все твои задачи (принять сообщение → сохранить лида/историю → ответить через AI) закрываются этим потоком: вебхук делает всё внутри BuildCRM, а конструктор только вызывает его и отправляет ответ.

---

## 2. Что настроить по шагам

### Шаг 1: Триггер

- **Тип:** входящее сообщение WhatsApp (или «событие сообщения»).
- Никаких дополнительных условий не нужно: на любое входящее сообщение запускаем поток.

### Шаг 2: Вызов вебхука (HTTP-запрос)

| Параметр | Значение |
|----------|----------|
| **URL** | `https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>` |
| | Подставь вместо `<tenantId>` ID клиента из BuildCRM (например `seed-tenant-1` или тот, что в настройках интеграции). |
| **Метод** | `POST` |
| **Headers** | `Content-Type: application/json` (если конструктор не ставит сам). |
| **Тело (Body)** | JSON с текстом сообщения и номером отправителя. |

**Формат payload ChatFlow (как у тебя работало раньше):**  
BuildCRM понимает payload вида `{ "instanceId": "...", "sender": { "id": "7706...", "name": "Ali" }, "message": { "type": "text", "text": "Текст сообщения" } }` — по нему берутся `sender.id` → телефон, `sender.name` → имя лида, `message.text` или `message.caption` → текст.

**Вход по ключу (как раньше):**  
Если в настройках клиента задан **Webhook Key**, в ChatFlow можно указать URL:  
`POST https://buildcrm-api.onrender.com/webhooks/chatflow?key=WEBHOOK_KEY`  
(без tenantId в пути; тенант определяется по ключу).

**Важно:** Данные можно передавать в **body** (JSON), в т.ч. формат выше, или в **query** (`?text=...&from=...`). Поддерживается и **GET** с query.

**Варианты тела, которые понимает наш API:**

1. В корне:
   ```json
   {
     "text": "Привет, хочу узнать цену",
     "from": "79001234567"
   }
   ```
   или `"phone": "79001234567"` вместо `"from"`.

2. Вложенный объект `message`:
   ```json
   {
     "message": {
       "text": "Привет, хочу узнать цену",
       "from": "79001234567"
     }
   }
   ```
   или `"body"` вместо `"text"` внутри `message`.

3. Массив `messages` (первый элемент):
   ```json
   {
     "messages": [
       {
         "text": "Привет",
         "from": "79001234567"
       }
     ]
   }
   ```
   или `"context": { "from": "79001234567" }` внутри элемента.

В конструкторе ChatFlow обычно есть переменные вроде «Текст входящего сообщения» и «Номер отправителя» — подставь их в выбранный формат (например в `text` и `from`).

### Шаг 3: Ответ вебхука (что возвращает BuildCRM)

Ответ приходит в формате JSON, например:

```json
{
  "received": true,
  "tenantId": "seed-tenant-1",
  "reply": "Спасибо за сообщение! Сейчас подготовим для вас информацию по запросу. Мы скоро свяжемся с вами."
}
```

- Если AI ответил или отправил шаблон/ночное сообщение — в `reply` будет строка с текстом.
- Если ответа нет (ошибка, AI выключен и т.п.) — может быть `"reply": null`.

### Шаг 4: Отправка сообщения в WhatsApp

- **Действие:** «Отправить сообщение» / «Send message» в WhatsApp.
- **Получатель:** тот же пользователь, который написал (номер из входящего сообщения).
- **Текст сообщения:** взять из ответа вебхука поле **`reply`**.

В конструкторах это обычно выглядит так:

- Переменная ответа вебхука, например: `webhookResponse` или `httpResponse.body`.
- Тогда текст сообщения задаётся как: **`webhookResponse.reply`** или **`httpResponse.body.reply`** (зависит от названий в твоём сервисе).

Если `reply` пришёл `null`, можно либо не отправлять сообщение, либо отправить запасной текст, например: «Принято, мы скоро ответим.»

---

## 3. Краткий чеклист для конструктора

- [ ] Триггер: входящее сообщение WhatsApp.
- [ ] Блок «HTTP-запрос» / «Webhook»: POST на  
      `https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>`.
- [ ] В теле запроса передаются текст сообщения и номер отправителя (в одном из форматов выше).
- [ ] В блоке «Отправить сообщение в WhatsApp» текст взят из ответа вебхука: **`reply`** (например `body.reply` или `webhookResponse.reply`).
- [ ] Сообщение отправляется тому же пользователю (номер из входящего сообщения).

---

## 4. Итог по задачам

| Задача | Где решается |
|--------|----------------|
| Принять сообщение из WhatsApp | Триггер конструктора + вызов нашего вебхука. |
| Сохранить/обновить лида в CRM | Внутри вебхука BuildCRM (по номеру телефона). |
| Сгенерировать ответ (AI / шаблон / ночной режим) | Внутри вебхука BuildCRM (AI + настройки клиента). |
| Отправить ответ обратно в WhatsApp | **Либо** BuildCRM сам (если у клиента в настройках заданы **ChatFlow Token** и **Instance ID**), **либо** блок в конструкторе: GET `send-text` с `msg=reply`. |

### Вариант A: BuildCRM сам шлёт ответ в WhatsApp (рекомендуется)

В **админке BuildCRM** у клиента в настройках WhatsApp заполни:
- **ChatFlow API Token** (token из личного кабинета ChatFlow)
- **Instance ID** (instance_id инстанса)

Тогда наш вебхук после генерации ответа сам вызовет **GET** `https://app.chatflow.kz/api/v1/send-text?token=...&instance_id=...&jid=НОМЕР@s.whatsapp.net&msg=ОТВЕТ`. В конструкторе ChatFlow достаточно **одного шага**: при входящем сообщении → **POST на наш вебхук** (тело с текстом и номером). Отправлять сообщение вручную в конструкторе не нужно.

### Вариант B: Отправка через конструктор ChatFlow

Если токен/instance не заданы, в ответе вебхука по-прежнему приходит поле **`reply`**. В конструкторе добавь шаг: **GET** на `https://app.chatflow.kz/api/v1/send-text` с параметрами `token`, `instance_id`, `jid` (номер отправителя в формате `79991234567@s.whatsapp.net`), `msg` = значение **`reply`** из ответа нашего вебхука.

Конструктор: **триггер → POST на наш вебхук** и (при варианте B) **→ GET send-text с msg=reply**.

---

## 5. Два потока: приветствие и обычный чат

Чтобы разделить **приветствие** (первое сообщение: текст + голос + фото) и **обычный диалог**, настрой в ChatFlow два сценария.

### Поток A — «Приветствие» (первый контакт)

- **Условие:** первое сообщение в чате (или «новый чат» — как это задаётся в конструкторе).
- **Шаг 1:** HTTP Request — **POST** на наш вебхук **с параметром `welcome=1`**:
  - URL: `https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>`  
  - Или в body (JSON) добавь поле `"welcome": 1`, либо в Query Parameters: `welcome=1`.
- **Ответ API:** JSON с полями:
  - `reply` — текст приветствия (от AI),
  - `welcomeVoiceUrl` — ссылка на голосовое (если настроено по теме),
  - `welcomeImageUrls` — массив ссылок на фото.
- **Шаг 2 в ChatFlow:** отправить текст — GET `send-text` с `msg` = значение **`reply`** из ответа.
- **Шаг 3 (если есть медиа):** для каждого URL из `welcomeVoiceUrl` и `welcomeImageUrls` — отправить медиа в WhatsApp. В конструкторе используй узел **«Отправить медиа по URL»** или **HTTP Request** к API отправки медиа (если у ChatFlow есть такой endpoint). Тогда голос и фото придут в чат как обычные сообщения WhatsApp.

Мы **не отправляем** сообщения сами в режиме welcome — только возвращаем JSON. Всю отправку (текст и медиа) делает твой поток в ChatFlow.

### Поток B — «Обычный чат» (все остальные сообщения)

- **Условие:** не первое сообщение (или «уже есть диалог»).
- **Шаг 1:** HTTP Request — **POST** на тот же URL **без** `welcome=1`:
  - `https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>`
  - Body/query как обычно (текст, номер).
- **Ответ API:** `reply: null`, `scheduledIn: 30`. BuildCRM сам запланирует ответ и через ~1 мин отправит текст (и по возможности медиа) через свой крон. В конструкторе можно ничего не отправлять — ответ придёт с нашей стороны.

Итого: один и тот же URL вебхука, различие по параметру **`welcome=1`** (в query или в body).

---

## 6. Голосовые и фото (приветственное медиа)

API ChatFlow (app.chatflow.kz) **не имеет endpoint send-media** — при вызове `send-media` возвращается HTML вместо JSON. Текстовые сообщения отправляются через **send-text** (работает).

**Fallback:** если send-media недоступен, API автоматически отправляет клиенту **ссылку на медиа текстом**. Клиент может открыть ссылку в браузере.

**Чтобы голос/фото приходили именно как сообщения WhatsApp** (голосовое сообщение, картинка в чате), нужна поддержка со стороны ChatFlow: endpoint `send-media` (GET или POST), который принимает `token`, `instance_id`, `jid`, `url`, `type` и отправляет медиа в WhatsApp. Наш API уже пробует GET и POST; если ChatFlow добавит такой endpoint — нативная отправка заработает без изменений в CRM. Альтернатива: в конструкторе ChatFlow настроить шаг «отправить медиа по URL», используя поля `welcomeVoiceUrl` и `welcomeImageUrls` из ответа вебхука.

**Вариант: настроить поток ChatFlow на отправку медиа**

Ответ вебхука теперь содержит поля **`welcomeVoiceUrl`** и **`welcomeImageUrls`** (если тема определена и в теме настроены голос/фото):

```json
{
  "received": true,
  "tenantId": "seed-tenant-1",
  "reply": null,
  "scheduledIn": 30,
  "topic": "panels",
  "welcomeVoiceUrl": "https://buildcrm-api.onrender.com/uploads/xxx.ogg",
  "welcomeImageUrls": ["https://buildcrm-api.onrender.com/uploads/yyy.png"]
}
```

**Что сделать в ChatFlow:**

1. После узла **«Вызвать вебхук»** добавь проверку: если в ответе есть **`welcomeVoiceUrl`**.
2. Добавь узел **«Отправить голосовое/аудио»** или аналогичный — если ChatFlow поддерживает **отправку по URL** (вместо загруженного файла), подставь `welcomeVoiceUrl` из ответа вебхука.
3. Аналогично для фото: если есть **`welcomeImageUrls`** — для каждого URL узел «Отправить изображение» (по URL, если поддерживается).

Если ChatFlow **не поддерживает отправку медиа по URL** (только статичные загруженные файлы) — загрузите голос и фото в ChatFlow вручную и добавьте узлы отправки по веткам **topic** (panels / laminate / linoleum / tractor), как описано в `PROMPT-AI-MANAGER-FULL.md`.
