# WhatsApp, привязанный к ChatFlow, «не читает» сообщения — что проверить

Если при написании на номер WhatsApp ничего не происходит (бот не отвечает, в логах BuildCRM нет записей «ChatFlow webhook received»), значит сообщения либо не доходят до ChatFlow, либо поток не вызывает наш вебхук. Ниже — что проверить по шагам.

---

## 1. ChatFlow получает сообщения от WhatsApp?

Чтобы ChatFlow вообще «читал» входящие сообщения, **WhatsApp (Meta) должен слать их в ChatFlow**.

- В **личном кабинете ChatFlow** (app.chatflow.kz) проверь:
  - Есть ли подключённый **инстанс / канал WhatsApp** и в каком он статусе (подключён / отключён / ошибка).
  - В настройках интеграции WhatsApp — указан ли **Callback URL** (URL, который Meta будет вызывать при новом сообщении). Обычно это адрес **серверов ChatFlow**, а не BuildCRM.
- В **Meta for Developers** (developers.facebook.com) → твоё приложение → **WhatsApp** → **Configuration**:
  - В поле **Webhook** должен быть подставлен **Callback URL и Verify Token из ChatFlow** (как в инструкции ChatFlow по подключению WhatsApp).
  - В **Webhook fields** должна быть подписка на поле **messages** (чтобы Meta отправлял события входящих сообщений в ChatFlow).

Если Callback URL указывает не на ChatFlow или не подписано поле `messages`, Meta не будет слать события в ChatFlow — тогда ChatFlow «не читает» просто потому, что ему не приходят входящие.

---

## 2. В ChatFlow есть поток на «входящее сообщение»?

Даже если Meta шлёт события в ChatFlow, нужно, чтобы у тебя был **опубликованный поток (бот/автоматизация)**, который:

- **Триггер:** «Входящее сообщение» / «Incoming message» / «Новое сообщение в WhatsApp» (или аналог для твоего инстанса).
- **Действие:** вызов нашего вебхука (POST или GET на `https://buildcrm-api.onrender.com/webhooks/chatflow/<tenantId>` с текстом и номером в body или в query).

Если триггер стоит на что-то другое (кнопка, ключевое слово, другой канал) или поток не опубликован/выключен — на обычное входящее сообщение в WhatsApp ничего не произойдёт.

---

## 3. Тестовое сообщение и логи

- Напиши **одно сообщение** на свой WhatsApp Business номер с другого телефона.
- Сразу зайди в **ChatFlow** и посмотри:
  - Есть ли это сообщение в разделе «Чаты» / «Сообщения» / «История»?
  - В разделе логов/выполнений потоков — появился ли запуск твоего потока в момент отправки сообщения?
- Если в ChatFlow **сообщения нет** и **поток не запускался** — проблема в п.1 (Meta → ChatFlow).
- Если **сообщение в ChatFlow есть**, но **поток не запускается** — проблема в настройке триггера или публикации потока (п.2).
- Если **поток запускается**, но в BuildCRM в логах нет «ChatFlow webhook received» — значит шаг «вызвать вебхук» не доходит до нашего URL или падает до него (проверь URL, метод, сеть в логах ChatFlow).

---

## 4. Итого: «в чём прикол»

«Прикол» обычно в одном из трёх:

1. **Meta не шлёт события в ChatFlow** — неверный или пустой Callback URL в Meta, нет подписки на `messages`.
2. **В ChatFlow нет работающего потока на входящее сообщение** — не тот триггер или поток не опубликован.
3. **Поток есть, но не вызывает наш API** — неверный URL вебхука, другой шаг вместо «вызвать URL/вебхук», или ошибка до запроса к нам.

Пройди п.1 и п.2, затем проверь по п.3 по одному сообщению — по тому, где обрывается цепочка (нет сообщения в ChatFlow / нет запуска потока / нет запроса в BuildCRM), будет ясно, что править.
