# BuildCRM — полный деплой на Render (Postgres + API + CRM + Admin)
# Подключите репозиторий к Render → New Blueprint Instance → выберите этот репо.
# Render создаст БД и 3 веб-сервиса и выдаст ссылки.

databases:
  - name: buildcrm-db
    databaseName: buildcrm
    plan: free
    region: oregon

services:
  # API (NestJS + Prisma) — Node runtime (preDeploy не поддерживается на free tier)
  - type: web
    name: buildcrm-api
    runtime: node
    rootDir: apps/api
    plan: free
    buildCommand: npm ci --include=dev && npx prisma generate && npx nest build
    startCommand: (npx prisma db push --skip-generate --accept-data-loss || true) && (npx prisma db seed || true) && node dist/src/main.js
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: buildcrm-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: PORT
        value: "4000"
      - key: NODE_ENV
        value: production
      - key: NODE_OPTIONS
        value: "--max-old-space-size=460"
      - key: CORS_ORIGIN
        value: "https://buildcrm-crm.onrender.com,https://buildcrm-admin.onrender.com"

  # CRM (Next.js) — приложение для менеджеров (фиксированный URL API для сборки)
  - type: web
    name: buildcrm-crm
    runtime: node
    rootDir: apps/crm
    plan: free
    buildCommand: npm install && npm run build
    startCommand: npx next start -p $PORT
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: "https://buildcrm-api.onrender.com"

  # Admin (Next.js) — админка (фиксированный URL API для сборки)
  - type: web
    name: buildcrm-admin
    runtime: node
    rootDir: apps/admin
    plan: free
    buildCommand: npm install && npm run build
    startCommand: npx next start -p $PORT
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: "https://buildcrm-api.onrender.com"
      - key: NODE_OPTIONS
        value: "--max-old-space-size=460"
